<!DOCTYPE html>
<html>
    <head>
        <title>Seacial Media - Admin Page</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="css/uikit.min.css" />
        <link rel="stylesheet" href="css/style.css" />
        <script src="js/seacial-localstorage.js"></script>
        <style>

.ma-table
{ 
  display: table;
}

.ma-tableRow
{
  display: table-row; 
}

.ma-tableBody
{
  display: table-row-group;
}

.ma-tableFoot
{
  display: table-footer-group;
}

.ma-tableCell, .ma-tableHead
{
  display: table-cell; 
}

.ma-table 
{
  display: table;
  width: 100%;
}
.ma-tableRow
{
  display: table-row;
}
.ma-tableHead
{
  background-color: #ddd;
}

.ma-tableCell, .ma-tableHead 
{
  display: table-cell;
  padding: 3px 10px;
  border: 1px solid #999999;
}

.ma-tableHead
{
/*RICK: deze gooide roet in het eten, header zag er raar uit... Ayal
  display: table-header-group;
*/
  background-color: #ddd;
  font-weight: bold;
}

.ma-tableFoot 
{
  display: table-footer-group;
  font-weight: bold;
  background-color: #ddd;
}
.ma-tableBody 
{
  display: table-row-group;
}


        </style>




<script>
var prev_onload_admin = window.onload;
window.onload = onload_admin;
function onload_admin()
{
    if (prev_onload_admin) {
	prev_onload_admin();
    }
    repopulateUsers();
    repopulateMessages();
    repopulateRequests();
    repopulateAccepts();
    repopulateData();
}


function repopulateAccepts() {
    repopulateVariable("accepts", "list-requests-accepted", "ACCEPTED", acceptsinfoFields);


}

function repopulateData() {
    repopulateVariable("data", "list-data-posted", "DATA", datainfoFields);
}

function repopulateVariable(tableid, elementid, section, infofields) {
    var table = getStorageObject()[tableid];
    var tableElement = document.getElementById(elementid);
    if (tableElement) {
        var text = "";
        text += MaTableBegin();
        text += MaSectionBeginList(section, "section-"+tableid, infofields);


	for (var key in table) {
	    // skip loop if the property is from prototype
	    if(!table.hasOwnProperty(key)) {
        	continue;
	    }
            text += MaAddList(key, table[key], ""+tableid+"_Operation_");
	}



        text += MaSectionEnd();
        text += MaTableEnd();
	tableElement.innerHTML = text; 
    }
}



function repopulateUsers() {
    repopulate("users","list-users", "USERS", userinfoFields);
}

function repopulateMessages() {
    repopulate("messages","list-messages", "MESSAGES", messageinfoFields);
}

function repopulateRequests() {
    repopulate("requests","list-requests", "REQUESTS", requestinfoFields);
}


function repopulate(tableid, elementid, section, infofields) {
    var table = getStorageObject()[tableid];
    var tableElement = document.getElementById(elementid);
    if (tableElement) {
        var text = "";

        text += MaTableBegin();
        text += MaSectionBegin(section, "section-"+tableid, infofields);

	for (var key in table) {
	    // skip loop if the property is from prototype
	    if(!table.hasOwnProperty(key)) {
        	continue;
	    }
            text += MaAdd(key, table[key], ""+tableid+"_Operation_");
	}

        text += MaSectionEnd();
        text += MaTableEnd();
	tableElement.innerHTML = text; 
    }
}






function users_Operation_change(key, row) {
    var newUserInfo = {};
    for (var i=0;i<userinfoFields.length;i++) {
        var element = document.getElementById("cell-"+row+"-"+userinfoFields[i]);
	if (element) {
	    newUserInfo[userinfoFields[i]] = element.innerHTML;
	    //alert("Value for "+userinfoFields[i]+" = "+element.innerHTML);
	}
    }
    updateUser(key,newUserInfo);
    repopulateUsers();
}

function users_Operation_delete(key) {
    removeUser(key);
    repopulateUsers();
}


function messages_Operation_delete(key) {
    removeMessage(key);
    repopulateMessages();
}


function messages_Operation_change(key, row) {
    var newMessageInfo = {};
    for (var i=0;i<messageinfoFields.length;i++) {
        var element = document.getElementById("cell-"+row+"-"+messageinfoFields[i]);
	if (element) {
	    newMessageInfo[messageinfoFields[i]] = element.innerHTML;
	    //alert("Value for "+userinfoFields[i]+" = "+element.innerHTML);
	}
    }
    updateMessage(key,newMessageInfo);
    repopulateMessages();
}








function requests_Operation_delete(key) {
    removeRequest(key);
    repopulateRequests();
}


function requests_Operation_change(key, row) {
    var newRequestInfo = {};
    for (var i=0;i<requestinfoFields.length;i++) {
        var element = document.getElementById("cell-"+row+"-"+requestinfoFields[i]);
	if (element) {
	    newRequestInfo[requestinfoFields[i]] = element.innerHTML;
	    //alert("Value for "+userinfoFields[i]+" = "+element.innerHTML);
	}
    }
    updateRequest(key,newRequestInfo);
    repopulateRequests();
}











function toggleVisibility(section) {
    if (sectionVisibility[section] == "table-cell") {
	sectionVisibility[section] = "none";
    }
    else {
	sectionVisibility[section] = "table-cell";
    }

    var elements = document.getElementsByClassName(section)
    for (var i = 0; i < elements.length; i++) {
	elements[i].style.display = sectionVisibility[section];
    }
}

var sectionVisibility = {};

function MaTableBegin() {
    var text="";

    sectionClass = "";
    text += "<div class='ma-table'>";

    return text;
}

function MaTableEnd() {
    var text="";

    text += "</div>";

    return text;
}

var sectionRow=0;


function MaSectionBeginList(sectionTitle, section, infoFields) {
    sectionRow=0;

    var text="";

    sectionClass = section;
    sectionVisibility[sectionClass] = "table-cell";
    text += "  <div class='ma-tableRow'>";
    text += "    <div class='ma-tableHead'><a href='javascript:toggleVisibility(\""+sectionClass+"\")'>"+sectionTitle+"</a></div>";

    for (var i=0;i<infoFields.length;i++) {
	text += "    <div class='ma-tableHead'>"+infoFields[i]+"</div>";
    }
    text += "  </div>";

    return text;
}


function MaSectionBegin(sectionTitle, section, infoFields) {
    sectionRow=0;

    var text="";

    sectionClass = section;
    sectionVisibility[sectionClass] = "table-cell";
    text += "  <div class='ma-tableRow'>";
    text += "    <div class='ma-tableHead'><a href='javascript:toggleVisibility(\""+sectionClass+"\")'>"+sectionTitle+"</a></div>";

    for (var i=0;i<infoFields.length;i++) {
	text += "    <div class='ma-tableHead'>"+infoFields[i]+"</div>";
    }
    text += "    <div class='ma-tableHead'>EDIT</div>";
    text += "    <div class='ma-tableHead'>DELETE</div>";
    text += "  </div>";

    return text;
}



function MaAddList(key, info,baseModifier) {
    sectionRow ++;

    var text="";

    text += "  <div class='ma-tableRow'>";
    text += "    <div class='ma-tableCell "+sectionClass+"'>"+key+"</div>";

    text += "    <div class='ma-tableCell "+sectionClass+"' id='cell-"+sectionRow+"' >"+JSON.stringify(info)+"</div>";

    text += "  </div>";
    return text;


}

function MaAdd(key, info,baseModifier)
{
    sectionRow ++;
    var text="";

    text += "  <div class='ma-tableRow'>";
    text += "    <div class='ma-tableCell "+sectionClass+"'>"+key+"</div>";

    for (var field in info) {
	// skip loop if the property is from prototype
	if(!info.hasOwnProperty(field)) {
            continue;
	}
        text += "    <div class='ma-tableCell "+sectionClass+"' id='cell-"+sectionRow+"-"+field+"' contenteditable='true' onkeypress='preventEnter(event)'>"+info[field]+"</div>";
    }

    text += "    <div class='ma-tableCell "+sectionClass+"'><a href='javascript:"+baseModifier+"change(\""+key+"\","+sectionRow+")'>Update</a></div>";
    text += "    <div class='ma-tableCell "+sectionClass+"'><a href='javascript:"+baseModifier+"delete(\""+key+"\")' onclick='confirm(\"Are you sure you want to remove user "+key+"?\")'>Remove</a></div>";
    text += "  </div>";
    return text;
}

function MaSectionEnd()
{
    var text="";
    return text;
}



function preventEnter(e) {
    if (e.keyCode === 10 || e.keyCode === 13) {
        e.preventDefault();
    }
}


var newNames = 
[
  "conor",
  "smith",
  "jones",
  "williams",
  "powell",
  "brown",  
  "wilson",
  "taylor",
  "nguyen",
  "johnson",
  "martin",
  "white",
  "anderson",
  "walker",
  "thompson",
  "thomas",
  "lee", 
  "harris",
  "ryan",
  "robinson",
  "kelly",
  "king"
];

var firstNames = 
[
  "John",
  "Sarah",
  "Jack",
  "Jennifer",
  "Frank",
];


function selectAdRandomFrom(list) {
    return list[Math.floor(Math.random()*list.length)];
}


function addNewUser() {
    var username = null;
    for (var i=0;i<newNames.length;i++) {
	if (!userExists(newNames[i])) {
		username = newNames[i];
		break;
        }
    }
    if (!username) {
        username=getNewUniqueId("user");
    }
    
    var firstname = selectAdRandomFrom(firstNames);

    var institute="";
    var boatName="";
    var role = "";
    if (Math.random()>0.5)
    {
      role="sailor";
      boatName = "Given Time";
    }
    else
    {
      role="academic";
      institute = "UvA";
    }
    
    addUser(username, {
        "firstname":firstname, 
        "role": role,
        "lastname":username, 
	      "institute":institute, 
	      "boatname":boatName, 
	      "email":"contact@seacial.com"
    });
    repopulateUsers();
}

//x repopulateMessages
//getNewUniqueId
//xgetTodayDateString


function getRandomUser() {
    var result = null;
    var users = getStorageObject()["users"];

    var count=0;
    for (var key in users) {
	// skip loop if the property is from prototype
	if(!users.hasOwnProperty(key)) {
            continue;
	}
	count++;
    }
    var index=Math.floor(count*Math.random());
    count=0;
    for (var key in users) {
	// skip loop if the property is from prototype
	if(!users.hasOwnProperty(key)) {
            continue;
	}
        if (count == index) {
	    result = key;
	}
	count++;
    }



/*@@@TODO remove?
    for (var key in users) {
        if (result == null)
	{
	  result = key;
	}
        if (Math.random()<0.5) {
	    result = key;
	}
    }
*/
    return result;
}



function getRandomRequest() {
    var result = null;
    var users = getStorageObject()["requests"];
    for (var key in users) {
        if (result == null)
	{
	  result = key;
	}
        if (Math.random()<0.5) {
	    result = key;
	}
    }
    return result;
}




var sampleMessages = 
[
  "Hey, how are you doing out there on the ocean?",
  "We have some new data for you!",
  "The data is amazing, TA!",
  "We're sorry to inform you that we were not able to capture that data. We got into a storm and had to change route.",
  "Hey, long time no hear! Was the data useful?"
];

function addNewMessage() {
    var type = (Math.random()>0.5) ? "personal" : "administrator"; 
    addMessage(getNewUniqueId("message"), {
        "type":type,
        "from":getRandomUser(), 
        "to": getRandomUser(),
        "description":selectAdRandomFrom(sampleMessages), 
	"date":getTodayDateString(), 
	"previous":""
    });
    repopulateMessages();
}



var sampleStatuses = 
[
  "Pending Approval",   //seen by academic
  "Approved",           //seen by academic and sailor as 'New'
  "Not Approved",       //seen by academic
  "Rejected",           //seen by sailor and academic as 'Approved'
  "Accepted",           //seen by sailor
  "Completed"           //seen by sailor and academic
];

var sampleRequestTypes = 
[
  "Temperature of the ocean water",
  "SO2 in the ocean water",
  "pH of the ocean water",
  "Salinity of the ocean water",
  "O3 in the air"
];

var sampleAreas = 
[
  "South Pacific - Chile",
  "South Atlantic - Brazil and Argentina",
  "North Pacific",
  "Indian",
  "South Atlantic",
  "South Pacific",
  "Mediterranean Sea"
];
var sampleDurations =
[
"3 months",
"6 months"
]
var sampleFrequencies =
[
"1 measure per day",
"2 measure per day"
]
var sampleDeadlines = 
[
"01-04-2019",
"21-7-2019"
]
var sampleDescriptions=
[
"Looking for vessels travelling along the coast of Chile (South Pacific Ocean). As a research group from the University of Melbourne we are researching the differences in ocean temperature in the South Pacific near the Australian coast and the coast of Chile. We need one measurement a day for a period of 3 months, preferably starting in January 2019. It would also be great if there is a vessel with cabins available so that we can perform the measurements ourselves. ",
"We are a research group from the University of Amsterdam researching effects of global warming on SO2 levels in the ocean. Our current project focuses on SO2 levels in the South Atlantic Ocean near the coast of Brazil and Argentina. We are looking for vessels around the area that are able to perform a simple SO2 measurement twice a day, one in the morning and one in the evening. It is also possible that multiple vessels around the area collect the data, we need as much as possible. Research is preferably for a duration of six months and we need the data by 21-7-2019."
]

function addNewRequest() {
    var request_number = Math.round(Math.random());
    console.log(request_number);
    addRequest(getNewUniqueId("request"), {
        "username":getRandomUser(), 
	    "area":sampleAreas[request_number],
        "description":sampleDescriptions[request_number], 
	    "reqtype":sampleRequestTypes[request_number],  
	    "status":selectAdRandomFrom(sampleStatuses),
        "duration":sampleDurations[request_number], 
	    "frequency":sampleFrequencies[request_number],
	    "deadline":sampleDeadlines[request_number]
    });
    repopulateRequests();
}

function addNewAccept() {
    var realLoggedInUser=loggedInUsername;
    loggedInUsername = getRandomUser();

    var loop;
    for (loop=0;loop<5;loop++) {
	var req = getRandomRequest();
	if (req) {
            if (addAccept(req)) {
	        break;
	    }
	}
	else {
	    break;
	}
    }
    loggedInUsername=realLoggedInUser;
    repopulateAccepts();

}

function addNewData() {
//@@@
}





function doResetDatabase() {
    resetDatabase();
    repopulateUsers();
    repopulateMessages();
    repopulateRequests();
}

</script>

    </head>
    <body>

<a href='javascript:doResetDatabase()' onclick='return confirm("Are you sure you want to reste the database?")'>Reset database</a>

<p>
<h1>Accounts</h1>
<a href='javascript:addNewUser()'>Add new user</a><br>
<div id='list-users'></div>
<p>

<h1>Messages</h1>
<a href='javascript:addNewMessage()'>Add new message</a><br>
<div id='list-messages'></div>
<p>


<h1>Requests</h1>
<a href='javascript:addNewRequest()'>Add new request</a><br>
<div id='list-requests'></div>
<p>

<h1>Requests: accepted by</h1>
<a href='javascript:addNewAccept()'>Add new accept</a><br>
<div id='list-requests-accepted'></div>

<h1>Data: posted for request</h1>
<a href='javascript:addNewData()'>Add new data</a><br>
<div id='list-data-posted'></div>

<p style="height:1in;">

    </body>
</html>
